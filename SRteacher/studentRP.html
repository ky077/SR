<div>
  <div class="row">
    <h3 class="text-center h6">
      <label>3年2班</label>
      <label class="mx-1">張花花</label>
      閱讀計畫</h3>
  </div>
  <!-- 資訊 start -->
  <div class="row g-2 align-items-center justify-content-center mb-3 px-5 fs-7 fw-gray-800">
    <div class="col-auto me-auto"> 書籍總數：
      <label>9</label>
    </div>
    <div class="col-auto me-auto"> 最近修改時間：
      <label>2022/08/11</label>
    </div>
    <div class="col-auto me-auto"> 最低難度：
      <label>SR 86</label>
    </div>
    <div class="col-auto me-auto"> 最高難度：
      <label>SR 515</label>
    </div>
  </div>
  <!-- 資訊  end  --> 
  <!-- 搜尋 start -->
  <div class="row g-2 align-items-center justify-content-between mb-3">
    <div class="col-auto me-3">
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          <label for="searchClassGrade" class="col-form-label fs-8">作答類別</label>
        </div>
        <div class="col-auto">
          <select class="form-select rounded-0 form-select-sm form-select-arrow-sm" id="searchClassGrade">
            <option value="" disabled="" selected="">請選擇...</option>
            <option value="">所有題本</option>
            <option value="">系統題本</option>
          </select>
        </div>
      </div>
    </div>
    <div class="col-auto me-3">
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          <label for="searchSessions" class="col-form-label fs-8">作答情況</label>
        </div>
        <div class="col-auto">
          <select class="form-select rounded-0 form-select-sm form-select-arrow-sm" id="searchSessions">
            <option value="" disabled="" selected="">請選擇...</option>
            <option value="">已作答</option>
            <option value="">未作答</option>
          </select>
        </div>
      </div>
    </div>
    <div class="col-auto me-3">
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          <label class="fs-8">圖標說明：</label>
        </div>
        <div class="col-auto">
          <button type="button" data-bs-toggle="popover" class="btn btn-link p-0"><i class="fa-solid fa-circle-question"></i></button>
        </div>
      </div>
    </div>
    <div class="col-auto ms-auto">
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          <label for="searchKeywords2" class="col-form-label fs-7">搜尋</label>
        </div>
        <div class="col-auto">
          <div class="input-group">
            <div class="input-group-clear">
              <input type="text" class="form-control rounded-0" placeholder="請輸入關鍵字..." aria-label="請輸入關鍵字..." aria-describedby="btnSearchRP" id="searchKeywords2">
              <button class="btn btn-close" type="button"></button>
            </div>
            <button class="btn btn-gray-100 rounded-0 border-gray-400 text-primary lh-1" type="button" id="btnSearchRP"><i class="fa-solid fa-magnifying-glass fs-5 mx-n1"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 搜尋  end  --> 
  <!-- 表格 start -->
  <div class="bg-body mx-n3 px-3">
    <table class="table table-borderless table-RPList" id="RPList">
      <thead>
        <tr>
          <th class="row-id">ID</th>
          <th class="row-index">序號</th>
          <th class="row-good">優選書</th>
          <th class="row-cover">書封面</th>
          <th class="row-bookTitle">書名</th>
          <th class="row-ebook">電子書</th>
          <th class="row-SR">圖書難度</th>
          <th class="row-sort">分類</th>
          <th class="row-readingDate">開始閱讀~結束閱讀</th>
          <th class="row-tool">功能</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="row-id">35845-52253</td>
          <td class="row-index"><span class="index-text">999</span></td>
          <td class="row-good"><img src="Content/images/recommendedBook/goodBook.png" alt=""/></td>
          <td class="row-cover"><a role="button" class="hover-effect-dark" data-toggle="modal" data-target="#frameModal" data-href="bookIntro.html"><img src="https://smartreading.net/RP/BookContent/BookFront/010.jpg"></a></td>
          <td class="row-bookTitle">走進生命花園</td>
          <td class="row-ebook"><img src="Content/images/recommendedBook/icon-ebook-gray.png" width="18" height="18"></td>
          <td class="row-SR" data-th="圖書難度">SR 448</td>
          <td class="row-sort" data-th="分類">成長/生命教育</td>
          <td class="row-readingDate"><div class="readingDate-start">
              <div class="readingDate-title"> 開始閱讀 </div>
              <div class="readingDate-content"> 2021/7/29 </div>
            </div>
            <div class="readingDate-end">
              <div class="readingDate-title"> 結束閱讀 </div>
              <div class="readingDate-content"> 2021/8/29 </div>
            </div></td>
          <td class="row-tool"><div class="tool-evaluation">
              <div class="row">
                <div class="col">
                  <div class="tool-title"> 系統題本 </div>
                  <div class="tool-content">
                    <button type="button" class="btn btn-link" data-toggle="modal" data-target="#frameModal" data-href="fillAssessment-bySystem.html?view"> <span class="userScore failed bySystem">B</span> </button>
                  </div>
                </div>
                <div class="col">
                  <div class="tool-title"> 教師命題 </div>
                  <div class="tool-content">
                    <button type="button" class="btn btn-link" data-toggle="modal" data-target="#frameModal" data-href="fillAssessment-byTeacher-teacherRating.html?view=0"> <span class="userScore failed byTeacher">待</span> </button>
                  </div>
                </div>
                <div class="col">
                  <div class="tool-title"> 我的書房 </div>
                  <div class="tool-content">
                    <button class="btn btn-outline-light" type="button" onclick="window.location='myStudy.html'"><img src="Content/images/RPList/myStudy-note-done.png">&nbsp;<img src="Content/images/RPList/myStudy-paint-done.png">&nbsp;<img src="Content/images/RPList/myStudy-audio.png">&nbsp;<img src="Content/images/RPList/myStudy-video-done.png"></button>
                  </div>
                </div>
              </div>
            </div></td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- 表格  end  --> 
</div>
<script>
(function () {
	//圖標說明 popovers
	var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
	var popoverList = popoverTriggerList.map(function (popoverTriggerList) {
		return new bootstrap.Popover(popoverTriggerList, {
			container: 'body',
			html: true,
			placement: 'bottom',
			trigger: 'hover focus',
			customClass: 'w-max-auto px-2',
			content: `<div class="mb-1 text-dark">系統評量分數</div>
					  <div class="mb-2">
						<span>通過：</span>
						<span class="userScore passed bySystem ">A+</span>&nbsp;&nbsp;<span class="userScore passed bySystem">A</span>
						<span class="ms-4">不通過：</span>
						<span class="userScore failed bySystem">B</span>
					  </div>
					  <hr>
					  <div class="mb-1 text-dark">教師評量分數</div>
					  <div class="mb-2">
						<span>通過：</span>
						<span class="userScore passed byTeacher">A+</span>&nbsp;&nbsp;<span class="userScore passed byTeacher">A</span>
						<span class="ms-4">不通過：</span>
						</span><span class="userScore failed byTeacher">B</span>
					  </div>`
		});
	}); 
	
	
    // 防止 studentRP.html 被 .load() 多次時重複執行
    if (window._studentRP_inited) return;
    window._studentRP_inited = true;

    window.initStudentRP = function () {
        let RPlist = $('#RPList');

        if (!$.fn.DataTable.isDataTable(RPlist)) {
            RPlist.DataTable({
				//serverSide: true,     // 開啟伺服端模式
				processing: true,   
				order: [],  //取消默認排序icon
				autoWidth: false,
				responsive: false,
				searching: true,
				pageLength: 6,
				pagingType: "simple_numbers",
				dom: '<"datatables-custom-header"B>'+
					 '<rt>'+
					 '<"datatables-custom-footer"pi>',				
				language: {
				  url: 'Content/widgets/DataTables/lang/Chinese-traditional.json'
				},
				ajax: 'Content/json/RP-bookList/RPlist.json',
				buttons:[	
					{
					  text: '依加入時間排序&nbsp;<span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>',
					  attr:  { id: 'sort_time', class: 'dt-button'},
					  action: function () {
						if( $('#sort_time').hasClass('asc')){ //原本asc↑，變desc↓
							this.order( row.startTime ).draw();
							$('#sort_time').removeClass('active asc desc').addClass('active desc').siblings('.dt-button').removeClass('active asc desc');
							$('#sort_time').find('.glyphicon').removeClass('glyphicon-arrow-up').addClass('glyphicon-arrow-down');
						}else{//原本null or desc↓變asc↑
							this.order( row.startTime ).draw();
							$('#sort_time').removeClass('active asc desc').addClass('active asc').siblings('.dt-button').removeClass('active asc desc');
							$('#sort_time').find('.glyphicon').removeClass('glyphicon-arrow-down').addClass('glyphicon-arrow-up');
						}
					  }
					},
					{
					  text: '依書籍難度值排序&nbsp;<span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span>',
					  attr:  { id: '', class: 'dt-button'},
					  action: function () {
						// do something...
					  }
					},
				],
				columnDefs: [
					{//ID
						targets: 0, 
						title: 'ID',
						data: 'id',
						className: 'row-id',
						orderable: false,
						visible: false
					},
					{//排序
						targets: 1, 
						title: '排序',
						className: 'row-index',
						orderable: false,
						type: 'string',
						render: function (data, type, row, meta) {
							const index = meta.row + 1; 
							return '<div class="index-text">' + index + '</div>'; 
						} 
					},
					{//優選書
						targets: 2, 
						title: '優選書',
						data: 'good',
						className: 'row-good',
						orderable: false, 
						render: function (data, type, row, meta) {
							let good;
							switch (data) {
								case 1:
									good = `<img src="Content/images/recommendedBook/goodBook.png" width="66" height="65">`;
									break
								case 0:
									good = ``;
									break    
								default:
									good = ``;
									break 
							}
							return good;
						} 
					},
					{//書封面
						targets: 3,
						title: '書封面',
						data: 'cover',
						className: 'row-cover',
						orderable: false,
						render: function (data, type, row, meta) {
							return `<img src="https://smartreading.net/RP/BookContent/BookFront/`+ data +`">`;
						} 
					},
					{//書名
						targets: 4, 
						title: '書名',
						data: 'bookTitle',
						className: 'row-bookTitle',
						orderable: false,
					},
					{//電子書
						targets: 5, 
						title: '電子書',
						data: 'ebook',
						className: 'row-ebook',
						orderable: false,
						render: function (data, type, row, meta) {
							let ebook;
							switch (data) {
								case 1:
									ebook = `<img src="Content/images/recommendedBook/icon-ebook.png" width="18" height="18">`;
									break
								case 0:
									ebook = `<img src="Content/images/recommendedBook/icon-ebook-gray.png" width="18" height="18">`;
									break    
								default:
									ebook = `<img src="Content/images/recommendedBook/icon-ebook-gray.png" width="18" height="18">`;
									break 
							}
							return ebook;
						} 
					},
					{//圖書難度
						targets: 6, 
						title: '圖書難度',
						data: 'SR',
						className: 'row-SR',
						orderable: true,
						render: function (data, type, row, meta) {
							return `SR `+ data;
						},
						createdCell: function (td, cellData, rowData, row, col) {
							$(td).attr('data-th', '圖書難度');
						}
					},
					{//分類
						targets: 7, 
						title: '分類',
						data: 'sort',
						className: 'row-sort',
						orderable: false,
						createdCell: function (td, cellData, rowData, row, col) {
							$(td).attr('data-th', '分類');
						}
					},
					{//開始閱讀~結束閱讀
						targets: 8, 
						title: '開始閱讀~結束閱讀',
						className: 'row-readingDate',
						orderable: false,
						render: function (data, type, row, meta) {
							return `<div class="readingDate-start">
							<div class="readingDate-title"> 開始閱讀 </div>
							<div class="readingDate-content">` + row.startTime+ `</div>
						  </div>
						  <div class="readingDate-end">
							<div class="readingDate-title"> 結束閱讀 </div>
							<div class="readingDate-content">` + row.endTime+ `</div>
						  </div>`;
						} 
					},
					{//工具
						targets: 9, 
						title: '工具',
						className: 'row-tool',
						orderable: false,
						render: function (data, type, row, meta) {
							const sys = row.systemQuiz?.[0] || {};
							const tea = row.teacherQuiz?.[0] || {};
							const study = row.myStudy || [];

							// systemQuiz 狀態判斷
							const sysLabel = !sys.done
							? '未作答'
							: (sys.score 
							   ? (() => {
									 // 根據分數等級決定額外 class
									 let extraClass = '';
									 if (sys.score === 'A' || sys.score === 'A+') {
									   extraClass = ' passed';
									 } else if (sys.score === 'B') {
									   extraClass = ' failed';
									 }
									 return `
									   <button type="button" class="btn btn-link btn-systemQuiz" data-review-type="${sys.reviewType}">
										 <span class="userScore ${sys.reviewType}${extraClass}">
										   ${sys.score}
										 </span>
									   </button>
									 `;
								   })() 
							   : '<button type="button" class="btn btn-outline-light btn-sm px-4 border-gray-400 text-primary btn-systemQuiz">批閱</button>');

							// teacherQuiz 狀態判斷
							const teaLabel = !tea.done
							? '未作答'
							: (tea.score 
							   ? (() => {
									 // 根據分數等級決定額外 class
									 let extraClass = '';
									 if (tea.score === 'A' || tea.score === 'A+') {
									   extraClass = ' passed';
									 } else if (tea.score === 'B') {
									   extraClass = ' failed';
									 }
									 return `
									   <button type="button" class="btn btn-link btn-teacherQuiz" data-review-type="${sys.reviewType}">
										 <span class="userScore ${tea.reviewType}${extraClass}">
										   ${tea.score}
										 </span>
									   </button>
									 `;
								   })() 
							   : '<button type="button" class="btn btn-outline-light btn-sm px-4 border-gray-400 text-primary btn-teacherQuiz">批閱</button>');

							// myStudy 狀態判斷
							const doneCount = study.filter(i => i.done).length;
							const scoredCount = study.filter(i => i.score).length;

							let studyLabel = '';
							if (doneCount > 0 && scoredCount < 4) studyLabel = '批閱';
							if (scoredCount === 4) studyLabel = '';//不用顯示分數

							// 生成圖片顯示（依 done 狀態）
							const imgHTML = study.map(i =>
							`<img src="Content/images/RPList/myStudy-${i.type}${i.done ? '-done' : ''}.png">`
							).join('&nbsp;');

							return `
							<div class="tool-evaluation">
							<div class="row">
							  <div class="col">
								<div class="tool-title">系統題本</div>
								<div class="tool-content">
								  ${sysLabel}
								</div>
							  </div>
							  <div class="col">
								<div class="tool-title">教師命題</div>
								<div class="tool-content">
								  ${teaLabel}
								</div>
							  </div>
							  <div class="col">
								<div class="tool-title">我的書房</div>
								<div class="tool-content">
								  <button class="btn btn-outline-light btn-sm border-gray-400 text-primary btn-myStudy" type="button">
									${studyLabel}
									${imgHTML}
								  </button>
								</div>
							  </div>
							</div>
							</div>`;
							}
					}
				],
				initComplete: function() {
					//datatable footer input page
					datatableInputPage(RPlist);
				}
			}); 
        }
    };
		
	//系統題本[批閱]
	$(document).on('click', '.btn-systemQuiz', function (){ 
		$('#reviewModal').modal('show')
						 .find('.modal-body .load-body')
						 .load('fillAssessment-bySystem-teacherRating.html', function () {
								//do something... (載入學生作答。
								//                 若老師評分過，載入老師評分)
			
								//分數select
								$('.assessment-select').selectpicker();
							 });
	});
	
	//教師命題[批閱]	
	$(document).on('click', '.btn-teacherQuiz', function () {
		$('#reviewModal').modal('show')
							 .find('.modal-body .load-body')
							 .load('fillAssessment-byTeacher-teacherRating.html', function () {
								//do something... (載入學生作答。
								//                 若老師評分過，載入老師評分)
			
								//分數select
								$('.assessment-select').selectpicker();
							 });
	});	
	
	//我的書房[批閱]	
	$(document).on('click', '.btn-myStudy', function () {
		$('#reviewModal').modal('show')
						 .find('.modal-body .load-body')
						 .load('myStudy-teacherRating.html', function () {
								//do something... (載入學生作答。
								//                 若老師評分過，載入老師評分)
			
								//分數select
								$('.assessment-select').selectpicker();
							 });
	});	
})();
</script>
